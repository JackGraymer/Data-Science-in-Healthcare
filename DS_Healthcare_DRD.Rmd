---
title: "DS Healthcare"
author: "Cervan, Del Conte, Kunz"
date: "2024-10-04"
output:
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
---

# Summary

This study aims to find out if the new "Ballot measure 110" regulation passed in the US state of Oregon in 2020 has had an impact on the number of drug-related deaths in the state. This measure decriminalized the possession of small amounts of drugs such as fentanyl and methamphetamine, among others. The data set used in this study  contains information on the number of drug-related deaths in Oregon and it´s neighbouring states, California and Washington from 2018 to 2024. The data set contains information on the month and year of the, the number, the state and the type of death.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data

```{r libraries, include=FALSE}
library(readxl)
library(dplyr)
library(zoo)
library(lubridate)
library(ggplot2)
library(tidyr)
library(lmtest)
library(sandwich)

#globally exclude code chunks from the output
knitr::opts_chunk$set(echo = FALSE)

#setting directory
#setwd(dirname(rstudioapi::getSourceEditorContext()$path))
getwd()
```


The data set used in this study contains information on drug-related deaths in Oregon, California, and Washington from 2018 to 2024. The data set includes the month and year of the death, the number of deaths, the state where the death occurred, and the type of death. For the population, the sex is also included.

For privacy reasons, the data set does not contain any personal information about the deceased individuals. Furthermore, in instances where the number of deaths is less than 10, the data is marked as "Suppressed" to protect the privacy of the individuals.

Also, to enrich the data with population information, we have a separate data set that contains the population counts for each state and year from 2010 to 2023.

```{r load main dataset, include=FALSE}
# load the relevant part of the Data set, exclude notes starting from row 4374
Data <- read_excel("data/Drug_related_Deaths_2018-2024.xlsx", n_max = 4374)


# Overview for the Data
head(Data, 10)
str(Data)

```

```{r load populaiton Data, include=FALSE}
# Read population data from Excel file for each region

# Load the population data from the first range (D244:M244)
population_oregon_1 <- read_excel("data/Ca_Or_Wa Population 2010-23.xlsx", 
                                  sheet = "Oregon", 
                                  range = "D244:M244", 
                                  col_names = FALSE)  # Disable header reading

# Load the population data from the second range (Q244:T244)
population_oregon_2 <- read_excel("data/Ca_Or_Wa Population 2010-23.xlsx", 
                                  sheet = "Oregon", 
                                  range = "Q244:T244", 
                                  col_names = FALSE)  # Disable header reading

# Combine the two data frames (horizontally) into one row
population_oregon <- cbind(population_oregon_1, population_oregon_2)

# Manually set the column names (years 2010 to 2023)
colnames(population_oregon) <- 2010:2023



# Load the population data from the first range in California
population_california_1 <- read_excel("data/Ca_Or_Wa Population 2010-23.xlsx", 
                                  sheet = "California", 
                                  range = "D487:M487", 
                                  col_names = FALSE)  # Disable header reading

# Load the population data from the second range (Q487:T487)
population_california_2 <- read_excel("data/Ca_Or_Wa Population 2010-23.xlsx", 
                                  sheet = "California", 
                                  range = "Q487:T487", 
                                  col_names = FALSE)  # Disable header reading

# Combine the two data frames (horizontally) into one row
population_california <- cbind(population_california_1, population_california_2)

# Manually set the column names (years 2010 to 2023)
colnames(population_california) <- 2010:2023



# Load the population data from the first range in Washington
population_washington_1 <- read_excel("data/Ca_Or_Wa Population 2010-23.xlsx", 
                                  sheet = "Washington", 
                                  range = "D286:M286", 
                                  col_names = FALSE)  # Disable header reading

# Load the population data from the second range 
population_washington_2 <- read_excel("data/Ca_Or_Wa Population 2010-23.xlsx", 
                                  sheet = "Washington", 
                                  range = "Q286:T286", 
                                  col_names = FALSE)  # Disable header reading

# Combine the two data frames (horizontally) into one row
population_washington <- cbind(population_washington_1, population_washington_2)

# Manually set the column names (years 2010 to 2023)
colnames(population_washington) <- 2010:2023


# Combine population data into a single data frame with an added column for state
population_data <- bind_rows(
  population_oregon %>% mutate(State = "Oregon"),
  population_washington %>% mutate(State = "Washington"),
  population_california %>% mutate(State = "California")
)


# Remove the temporary variables from the environment
rm(population_oregon_1, population_oregon_2, population_washington_1, 
   population_washington_2, population_california_1, population_california_2,
   population_oregon, population_washington, population_california)

# Convert wide format to long format
population_data <- population_data %>%
  pivot_longer(cols = -State,    # All columns except 'State'
               names_to = "year",   # The new column for years
               values_to = "population_count")  # The new column for population counts

#Convert year collum to numeric
population_data$year <- as.numeric(population_data$year)  

```

## Data Exploration and Cleaning

The initial data exploration involves checking for missing values, duplicates, and inconsistencies in the dataset. We will also examine the data types of each column and make necessary adjustments to ensure the data is suitable for analysis. This includes converting the date column to a standardized format, handling suppressed values, and removing unnecessary columns.

Some columns were duplicated as a code, such as *Occurrence State* and *State Code*, columns that end with *Code* will be removed. 
At the botom, the data set included a *Notes* column that contained text only, explaining some details as the previously mentioned suppressed values. This column was removed and the relevant information was taken into account.

Dates were converted to a standardized format using lubridate package. The column *Deaths* contained some values marked as "Suppressed", which indicates that the actual number of deaths is between 1 and 9. To handle this, we replaced these values with random numbers between 1 and 9.

Enriched with a *Provisional* column, which indicates whether the data is provisional or not. This information was extracted from the *Month* column.

```{r Data Explorations, include=FALSE}

# look into Notes
unique(Data$Notes)

# only NA's so we delete this column
Data <- Data %>% select(-Notes)

# look into Dates
unique(Data$Month)

# Delete Row Sep., 2024 since the data is not complete
Data <- Data[Data$Month != "Sep., 2024 (provisional and partial)", ]

# Create column Provisional (TRUE/FALSE) based on the col Month '(provisional)'
Data$Provisional <- grepl("\\(provisional\\)", Data$Month)

# Delete " (provisional)" from the Date
####Data$Month <- gsub(" \\(provisional\\)", "", Data$Month)

# Convert into Date Variable
####Data$Month <- as.yearmon(Data$Month, format = "%b., %Y")
Data <- Data %>%
  #mutate(`Month` = as.yearmon(`Month Code`, format = "%Y/%m"))
    mutate(`Month` = ym(`Month Code`))


#### look into Deaths
#### Data$Deaths

# count of "Suppressed"
sum(Data$Deaths == "Suppressed")

# Some of the numbers are "Suppressed" this means that there are between 1 and 9 cases
# To use Deaths as a number we can leave them as NA's or substitute by a random number between 1 and 9

# Set seed for reproducibility if needed
set.seed(23)  

# Replace "Suppressed" in the Death column with a random number between 1 and 9
Data$Deaths <- ifelse(Data$Deaths == "Suppressed", sample(1:9, sum(Data$Deaths == "Suppressed"), replace = TRUE), Data$Deaths)
Data$Deaths <- as.numeric(Data$Deaths)

summary(Data)
sum(Data$Deaths == "Suppressed")
# Delete all columns that end on Code, they are duplicates of the other columns
Data <- Data[, !grepl("Code$", names(Data))]

glimpse(Data)
```

# Exploratory Data Analysis

## Baseline and Trend Analysis
We will calculate the drug-related death rates for Oregon, California, and Washington for all complete years in our dataset to have an overview of the situation. We then focus on the years 2018-2020 prior to the law’s enactment, to establish any pre-existing trends. 
Although the dataset does not include details on socioeconomic factors or the effects of COVID-19, we will acknowledge these as potential confounding variables and incorporate them into the discussion when interpreting the results. This analysis will help isolate changes attributable to the law rather than external factors.

```{r Baseline and Trend Analysis}

# Filter the data for each complete years 2018 to 2023 
Data_18_23 <- Data %>%
  filter(`Month` >= ym("2018-01") & `Month` <= ym("2023-12"))

# Group the data by occurrence state and year, then sum deaths per year
Data_18_23 <- Data_18_23 %>%
  group_by(`Occurrence State`, year = year(`Month`)) %>%
  summarise(Deaths = sum(Deaths))

# Merge the death data with population data by state and year
Data_with_population <- Data_18_23 %>%
  left_join(population_data, by = c("Occurrence State" = "State", "year" = "year"))

# Calculate deaths per 100,000 inhabitants for each year
Data_with_population <- Data_with_population %>%
  mutate(Deaths_per_100000 = (Deaths / population_count) * 100000)


# Plot the number of deaths per 10,000 inhabitants for each year and state
ggplot(Data_with_population, aes(x = factor(year), y = Deaths_per_100000, fill = `Occurrence State`)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Deaths per 100'000 Inhabitants (2018-2023)",
       x = "Year",
       y = "Deaths per 100'000 Inhabitants") +
  theme_minimal()


# Plot the trends over time for each state per year
ggplot(Data_with_population, aes(x = year, y = Deaths_per_100000, color = `Occurrence State`)) +
  geom_line(linewidth = 1.2) +
  geom_vline(xintercept = 2021, linetype = "dashed", color = "red") +  # Mark the policy change
  labs(title = "Deaths per 100,000 Inhabitants by State",
       subtitle = "Oregon policy change in 2021",
       x = "Year", y = "Deaths per 100,000 inhabitants") +
  theme_minimal()
```

```{r Baseline and Trend Analysis for drug induced deaths}

# Filter the data for each complete years 2018 to 2023 and make sure to use only durg induced cases
Data_18_23 <- Data %>%
  filter(`Month` >= ym("2018-01") & `Month` <= ym("2023-12") & `UCD - Drug/Alcohol Induced` == "Drug-induced causes")

# Group the data by occurrence state and year, then sum deaths per year
Data_18_23 <- Data_18_23 %>%
  group_by(`Occurrence State`, year = year(`Month`)) %>%
  summarise(Deaths = sum(Deaths))

# Merge the death data with population data by state and year
Data_with_population <- Data_18_23 %>%
  left_join(population_data, by = c("Occurrence State" = "State", "year" = "year"))

# Calculate deaths per 100,000 inhabitants for each year
Data_with_population <- Data_with_population %>%
  mutate(Deaths_per_100000 = (Deaths / population_count) * 100000)


# Plot the number of deaths per 10,000 inhabitants for each year and state
ggplot(Data_with_population, aes(x = factor(year), y = Deaths_per_100000, fill = `Occurrence State`)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Drug-Related Deaths per 100'000 Inhabitants (2018-2023)",
       x = "Year",
       y = "Deaths per 100'000 Inhabitants") +
  theme_minimal()


# Plot the trends over time for each state per year
ggplot(Data_with_population, aes(x = year, y = Deaths_per_100000, color = `Occurrence State`)) +
  geom_line(linewidth = 1.2) +
  geom_vline(xintercept = 2021, linetype = "dashed", color = "red") +  # Mark the policy change
  labs(title = "Drug-Related Deaths per 100,000 Inhabitants by State",
       subtitle = "Oregon policy change in 2021",
       x = "Year", y = "Deaths per 100,000 inhabitants") +
  theme_minimal()
```
```{r Baseline and Trend Analysis for drug induced deaths percentage}

# Filter the data for each complete years 2018 to 2023 and make sure to use only durg induced cases
Data_18_23 <- Data %>%
  filter(`Month` >= ym("2018-01") & `Month` <= ym("2023-12") & `UCD - Drug/Alcohol Induced` == "Drug-induced causes")

# Group the data by occurrence state and year, then sum deaths per year
Data_18_23 <- Data_18_23 %>%
  group_by(`Occurrence State`, year = year(`Month`)) %>% 
  summarise(Deaths = sum(Deaths))

all_deaths_18_23 <- Data %>%
  filter(`Month` >= ym("2018-01") & `Month` <= ym("2023-12"))%>%
  group_by(`Occurrence State`, year = year(`Month`)) %>% 
  summarise(Deaths = sum(Deaths))

Data_18_23$allDeaths <- all_deaths_18_23$Deaths

# Merge the death data with population data by state and year
Data_with_population <- Data_18_23 %>%
  left_join(population_data, by = c("Occurrence State" = "State", "year" = "year"))

# Calculate deaths per 100,000 inhabitants for each year
Data_with_population <- Data_with_population %>%
  mutate(Drugdeaths = (Deaths / allDeaths) * 100)

# View the result
print(Data_with_population)

# Plot the number of deaths per 10,000 inhabitants for each year and state
ggplot(Data_with_population, aes(x = factor(year), y = Drugdeaths, fill = `Occurrence State`)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Percentage of Drug-Related Deaths on all Deaths(2018-2023)",
       x = "Year",
       y = "Percentage of Drug-Related Deaths") +
  theme_minimal()


# Plot the trends over time for each state per year
ggplot(Data_with_population, aes(x = year, y = Drugdeaths, color = `Occurrence State`)) +
  geom_line(linewidth = 1.2) +
  geom_vline(xintercept = 2021, linetype = "dashed", color = "red") +  # Mark the policy change
  labs(title = "Percentage of Drug-Related Deaths on all Deaths(2018-2023)",
       subtitle = "Oregon policy change in 2021",
       x = "Year", y = "Percentage of Drug-Related Deaths") +
  theme_minimal()



```



# For this Analyis we wanted to look at the monthly numbers

```{r Diference In Differences Analysis}

# Filter the data for each complete month in 2018 to 2023 
Data_monthly <- Data %>%
  filter(`Month` >= ym("2018-01") & `Month` <= ym("2023-12"))

# Group the data by occurrence state and month, then sum deaths per month
Data_monthly <- Data_monthly %>%
  group_by(`Occurrence State`, year = year(`Month`), month = month(`Month`)) %>%
  summarise(Deaths = sum(Deaths))


# Merge the death data with population data by state and year
Data_monthly <- Data_monthly %>%
  left_join(population_data, by = c("Occurrence State" = "State", "year" = "year"))

# Calculate deaths per 100,000 inhabitants for each year
Data_monthly <- Data_monthly  %>%
  mutate(Deaths_per_100000 = (Deaths / population_count) * 100000)


# Create 'treatment' and 'post_policy' variables
Data_monthly <- Data_monthly %>%
  mutate(
    treatment = ifelse(`Occurrence State` == "Oregon", 1, 0),  # 1 for Oregon, 0 for California/Washington
    post_policy = ifelse(year >= 2021, 1, 0),  # 1 for years 2021 and later
    interaction = treatment * post_policy  # Interaction term for DiD
  )

# Create a new date column by combining year and month
Data_monthly <- Data_monthly %>%
  mutate(date = ym(paste(year, month, sep = "-")))  # Combine year and month into a date


# Difference-in-Differences (DiD) regression model with Deaths_per_100000

did_model <- lm(Deaths_per_100000 ~ treatment + post_policy + interaction, data = Data_monthly)
summary(did_model)

# Robust standard errors to handle heteroscedasticity
coeftest(did_model, vcov = vcovHC(did_model, type = "HC1"))

```
## Model interpretation
In this analysis, a **Difference-in-Differences (DiD)** model was applied to evaluate the impact of Oregon's decriminalization policy on drug-related deaths. Three key variables were included in the model:

1. **Treatment**: This variable identifies whether a state is part of the treatment group. In this case, Oregon was assigned a value of 1 (treatment group), while California and Washington, which served as control states, were assigned a value of 0.
   
2. **Post-policy**: This variable distinguishes the period before and after the policy change. It takes a value of 1 for observations from 2021 and later (post-policy period), and 0 for years prior to the policy implementation.
   
3. **Interaction**: The interaction term between the treatment and post-policy variables captures the key DiD effect. This term measures the change in the outcome (deaths per 100,000 inhabitants) in Oregon after the policy change, relative to the trends in the control states.

#### Key Coefficients:
- The **intercept** (85.849) represents the baseline level of drug-related deaths per 100,000 in the control states (California and Washington) before the policy change.
- The **treatment coefficient** (21.017) indicates that, before the policy change, Oregon had 21.017 more deaths per 100,000 compared to the control states.
- The **post-policy coefficient** (9.759) shows that, on average, across all states, drug-related deaths increased by 9.759 per 100,000 after 2021, regardless of the policy.
- The **interaction coefficient** (6.033) represents the estimated effect of the policy in Oregon, showing that the increase in deaths per 100,000 in Oregon after the policy change was 6.033 higher than the increase observed in the control states. However, this effect was not statistically significant (p-value = 0.184), suggesting that there is insufficient evidence to conclude that the policy had a meaningful impact on the outcome.


```{r Plot}

# Plot the trends over time for each state
ggplot(Data_monthly, aes(x = date, y = Deaths_per_100000, color = `Occurrence State`)) +
  geom_line(linewidth = 1.2) +
  geom_vline(xintercept = as.Date("2021-02-01"), linetype = "dashed", color = "red") +  # Mark the policy change
  labs(title = "Drug-Related Deaths by State per 100000",
       subtitle = "Oregon policy change in February 2021",
       x = "Year", y = "Deaths_per_100000") +
  theme_minimal()


# Generate predicted values based on the model
Data_monthly$predicted <- predict(did_model, newdata = Data_monthly)

# Visualize the predicted trends
ggplot(Data_monthly, aes(x = date, y = predicted, color = `Occurrence State`)) +
  geom_line(linewidth = 1.2) +
  geom_vline(xintercept = as.Date("2021-02-01"), linetype = "dashed", color = "red") +  # Mark the policy change
  labs(title = "Predicted Drug-Related Deaths per 100,000 Over Time",
       subtitle = "Oregon vs Control States",
       x = "Date", y = "Predicted Deaths per 100,000 inhabitants") +
  theme_minimal()
```

### Regression Discontinuity Analysis

```{r Regression Discontinuity Analysis}
# Regression Discontinuity Analysis: To further validate the DiD results

# Filter the data for the entire period from 2018 to 2023
Data_RD <- Data_monthly %>%
  filter(date >= as.Date("2018-01-01") & date <= as.Date("2023-12-01") & `Occurrence State` == "Oregon")

# Create a binary variable for the policy change
Data_RD <- Data_RD %>%
  mutate(policy_change = ifelse(date >= as.Date("2021-02-01"), 1, 0))

# Fit a regression model to estimate the effect of the policy change
rd_model <- lm(Deaths_per_100000 ~ policy_change, data = Data_RD)
summary(rd_model)

# Robust standard errors to handle heteroscedasticity
coeftest(rd_model, vcov = vcovHC(rd_model, type = "HC1"))

# Plot the regression discontinuity analysis
ggplot(Data_RD, aes(x = date, y = Deaths_per_100000, color = as.factor(policy_change))) +
  geom_line(linewidth = 1.2) +
  geom_vline(xintercept = as.Date("2021-02-01"), linetype = "dashed", color = "red") +  # Mark the policy change
  # Legend
  scale_color_manual(values = c("0" = "blue", "1" = "red"), labels = c("Before Policy", "After Policy")) +
  labs(title = "Regression Discontinuity Analysis",
       subtitle = "Effect of Oregon Policy Change in 2021 (Oregon Only)",
       x = "Date", y = "Deaths per 100,000 inhabitants") +
  theme_minimal()

```

The regression discontinuity analysis indicates a significant increase in drug-related deaths following Oregon's 2021 decriminalization policy. The model estimates an increase of approximately 15 deaths per 100,000 inhabitants after the policy change, with a highly significant p-value (p < 0.001). This suggests a strong association between the policy and the rise in drug-related deaths. However, the model explains only about 37.86% of the variance in deaths, implying that other factors, such as external events or systemic issues, may also influence these trends. Further analysis is required to account for additional variables.