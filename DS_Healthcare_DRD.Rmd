---
title: "DS Healthcare"
author: "Cervan, Del Conte, Kunz"
date: "2024-10-04"
output:
  pdf_document:
    number_sections: true
---

\newpage
\tableofcontents
\newpage

# Summary

This study aims to find out if the new "Ballot measure 110" regulation passed in the US state of Oregon in 2020 has had an impact on the number of drug-related deaths in the state. This measure decriminalized the possession of small amounts of drugs such as fentanyl and methamphetamine, among others. The data set used in this study  contains information on the number of drug-related deaths in Oregon and it´s neighbouring states, California and Washington from 2018 to 2024. Furthermore contains information on the month and year of the death, the number of deaths, the state and the type of death.For the population, the sex is also included.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data

```{r libraries, include=FALSE}
library(readxl)
library(dplyr)
library(zoo)
library(lubridate)
library(ggplot2)
library(tidyr)
library(lmtest)
library(sandwich)
library(forecast)
library(plm)

#globally exclude code chunks from the output
knitr::opts_chunk$set(echo = FALSE)

#globally turn on caching
knitr::opts_chunk$set(cache = TRUE)

# globally turn off warnings and messages
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)

# globally set the theme for ggplot
theme_set(theme_minimal())

#setting directory
#setwd(dirname(rstudioapi::getSourceEditorContext()$path))
getwd()
```

For privacy reasons, the data set does not contain any personal information about the deceased individuals. Furthermore, in instances where the number of deaths is less than 10, the data is marked as "Suppressed" to protect the privacy of the individuals.

Also, to enrich the data with population information, a separate data set that contains the population counts for each state and year from 2010 to 2023 is used.

```{r load main dataset, include=FALSE}
# load the relevant part of the Data set, exclude notes starting from row 4374
Data <- read_excel("data/Drug_related_Deaths_2018-2024.xlsx", n_max = 4374)


# Overview for the Data
head(Data, 10)
str(Data)

```

```{r load populaiton Data, include=FALSE}
# Read population data from Excel file for each region

# Load the population data from the first range (D244:M244)
population_oregon_1 <- read_excel("data/Ca_Or_Wa Population 2010-23.xlsx", 
                                  sheet = "Oregon", 
                                  range = "D244:M244", 
                                  col_names = FALSE)  # Disable header reading

# Load the population data from the second range (Q244:T244)
population_oregon_2 <- read_excel("data/Ca_Or_Wa Population 2010-23.xlsx", 
                                  sheet = "Oregon", 
                                  range = "Q244:T244", 
                                  col_names = FALSE)  # Disable header reading

# Combine the two data frames (horizontally) into one row
population_oregon <- cbind(population_oregon_1, population_oregon_2)

# Manually set the column names (years 2010 to 2023)
colnames(population_oregon) <- 2010:2023



# Load the population data from the first range in California
population_california_1 <- read_excel("data/Ca_Or_Wa Population 2010-23.xlsx", 
                                  sheet = "California", 
                                  range = "D487:M487", 
                                  col_names = FALSE)  # Disable header reading

# Load the population data from the second range (Q487:T487)
population_california_2 <- read_excel("data/Ca_Or_Wa Population 2010-23.xlsx", 
                                  sheet = "California", 
                                  range = "Q487:T487", 
                                  col_names = FALSE)  # Disable header reading

# Combine the two data frames (horizontally) into one row
population_california <- cbind(population_california_1, population_california_2)

# Manually set the column names (years 2010 to 2023)
colnames(population_california) <- 2010:2023



# Load the population data from the first range in Washington
population_washington_1 <- read_excel("data/Ca_Or_Wa Population 2010-23.xlsx", 
                                  sheet = "Washington", 
                                  range = "D286:M286", 
                                  col_names = FALSE)  # Disable header reading

# Load the population data from the second range 
population_washington_2 <- read_excel("data/Ca_Or_Wa Population 2010-23.xlsx", 
                                  sheet = "Washington", 
                                  range = "Q286:T286", 
                                  col_names = FALSE)  # Disable header reading

# Combine the two data frames (horizontally) into one row
population_washington <- cbind(population_washington_1, population_washington_2)

# Manually set the column names (years 2010 to 2023)
colnames(population_washington) <- 2010:2023


# Combine population data into a single data frame with an added column for state
population_data <- bind_rows(
  population_oregon %>% mutate(State = "Oregon"),
  population_washington %>% mutate(State = "Washington"),
  population_california %>% mutate(State = "California")
)


# Remove the temporary variables from the environment
rm(population_oregon_1, population_oregon_2, population_washington_1, 
   population_washington_2, population_california_1, population_california_2,
   population_oregon, population_washington, population_california)

# Convert wide format to long format
population_data <- population_data %>%
  pivot_longer(cols = -State,    # All columns except 'State'
               names_to = "year",   # The new column for years
               values_to = "population_count")  # The new column for population counts

#Convert year column to numeric
population_data$year <- as.numeric(population_data$year)  

```

## Data Exploration and Cleaning

The initial data exploration involves checking for missing values, duplicates, and inconsistencies in the dataset. We will also examine the data types of each column and make necessary adjustments to ensure the data is suitable for analysis. This includes converting the date column to a standardized format, handling suppressed values, and removing unnecessary columns.

Some columns were duplicated as a code, such as *Occurrence State* and *State Code*, columns that end with *Code* will be removed. 
At the botom, the data set included a *Notes* column that contained text only, explaining some details as the previously mentioned suppressed values. This column was removed and the relevant information was taken into account.

Dates were converted to a standardized format using lubridate package. The column *Deaths* contained some values marked as "Suppressed", which indicates that the actual number of deaths is between 1 and 9. To handle this, we replaced these values with random numbers between 1 and 9.

Enriched with a *Provisional* column, which indicates whether the data is provisional or not. This information was extracted from the *Month* column.

```{r Data Explorations, echo=TRUE}

# look into Dates 
unique(Data$Month)

# Delete Notes column without grepl 
Data <- Data[, !grepl("Notes", names(Data))]

# Delete Row Sep., 2024 since the data is not complete
Data <- Data[Data$Month != "Sep., 2024 (provisional and partial)", ]

# Create column Provisional (TRUE/FALSE) based on the col Month '(provisional)'
Data$Provisional <- grepl("\\(provisional\\)", Data$Month)

# Delete " (provisional)" from the Date
####Data$Month <- gsub(" \\(provisional\\)", "", Data$Month)

# Convert into Date Variable
####Data$Month <- as.yearmon(Data$Month, format = "%b., %Y")
Data <- Data %>%
  #mutate(`Month` = as.yearmon(`Month Code`, format = "%Y/%m"))
    mutate(`Month` = ym(`Month Code`))


#### look into Deaths
#### Data$Deaths

# count of "Suppressed"
sum(Data$Deaths == "Suppressed")

# Some of the numbers are "Suppressed" this means that there are between 1 and 9 cases
# To use Deaths as a number we can leave them as NA's or substitute by a random number between 1 and 9

# Set seed for reproducibility if needed
set.seed(23)  

# Replace "Suppressed" in the Death column with a random number between 1 and 9
Data$Deaths <- ifelse(Data$Deaths == "Suppressed", sample(1:9, sum(Data$Deaths == "Suppressed"), replace = TRUE), Data$Deaths)
Data$Deaths <- as.numeric(Data$Deaths)

summary(Data)
sum(Data$Deaths == "Suppressed")
# Delete all columns that end on Code, they are duplicates of the other columns
Data <- Data[, !grepl("Code$", names(Data))]

# keep one version of the Dataset with all Deaths
Data_complete <- Data

# Filters the data to only include drug-induced deaths (removes alcohol-induced and non-drug related deaths)
Data <- Data %>% filter(`UCD - Drug/Alcohol Induced` == "Drug-induced causes")

glimpse(Data)
```

# Analysis

## Baseline and Trend Analysis
We will calculate the drug-related death rates for Oregon, California, and Washington for all complete years in our dataset to have an overview of the situation. We then focus on the years 2018-2020 prior to the law’s enactment, to establish any pre-existing trends. 
Although the dataset does not include details on socioeconomic factors or the effects of COVID-19, we will acknowledge these as potential confounding variables and incorporate them into the discussion when interpreting the results. This analysis will help isolate changes attributable to the law rather than external factors.

```{r Baseline and Trend Analysis for drug induced deaths}

# Filter the data for each complete years 2018 to 2023
Data_18_23 <- Data %>%
  filter(`Month` >= ym("2018-01") & `Month` <= ym("2023-12"))

# Group the data by occurrence state and year, then sum deaths per year
Data_18_23 <- Data_18_23 %>%
  group_by(`Occurrence State`, year = year(`Month`)) %>%
  summarise(Deaths = sum(Deaths))

# Merge the death data with population data by state and year
Data_with_population <- Data_18_23 %>%
  left_join(population_data, by = c("Occurrence State" = "State", "year" = "year"))

# Calculate deaths per 100,000 inhabitants for each year
Data_with_population <- Data_with_population %>%
  mutate(Deaths_per_100000 = (Deaths / population_count) * 100000)


# Plot the number of deaths per 10,000 inhabitants for each year and state
ggplot(Data_with_population, aes(x = factor(year), y = Deaths_per_100000, fill = `Occurrence State`)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Drug-Related Deaths per 100'000 Inhabitants (2018-2023)",
       x = "Year",
       y = "Deaths per 100'000 Inhabitants")


# Plot the trends over time for each state per year
ggplot(Data_with_population, aes(x = year, y = Deaths_per_100000, color = `Occurrence State`)) +
  geom_line(linewidth = 1.2) +
  geom_vline(xintercept = 2021, linetype = "dashed", color = "red") +  # Mark the policy change
  labs(title = "Drug-Related Deaths per 100,000 Inhabitants by State",
       subtitle = "Oregon policy change in 2021",
       x = "Year", y = "Deaths per 100,000 inhabitants")
```

## Difference by Gender
```{r Difference by Gender}
# Prepare the data
data_gender_year <- Data %>%
  select(Gender, Month, Deaths) %>%
  group_by(Gender, Month) %>%
  summarise(Total_Deaths = sum(Deaths, na.rm = TRUE)) %>%
  ungroup()

# Plot the data
ggplot(data_gender_year, aes(x = Month, y = Total_Deaths, color = Gender, group = Gender)) +
  geom_line() +
  geom_point() +
  labs(title = "Number of Deaths by Gender and Year",
       x = "Year",
       y = "Total Deaths",
       color = "Gender") 

# Perform t-test for significant differences by gender 
t.test(Total_Deaths ~ Gender, data = data_gender_year)

```

The Welch two-sample t-test results indicate a statistically significant difference in drug-related deaths between males and females. The test produced a t-statistic of -13.287 with 93.404 degrees of freedom and a p-value less than 2.2e-16, which is well below the common significance threshold of 0.05. This strongly suggests that the difference in means between the two groups is not due to random chance.

The mean number of drug-related deaths in the female group is 282.94, while the mean in the male group is significantly higher at 761.59. The 95% confidence interval for the difference in means ranges from -550.18 to -407.12, further confirming that male drug-related deaths are significantly higher than female deaths.

In conclusion, the analysis shows a highly significant difference in drug-related deaths between males and females, with males experiencing a considerably higher number of deaths on average.

# TODO For this Analyis we wanted to look at the monthly numbers
## Difference-in-Differences (DiD) Analysis

```{r Diference In Differences Analysis}

# Filter the data for each complete month in 2018 to 2023 
Data_monthly <- Data %>%
  filter(`Month` >= ym("2018-01") & `Month` <= ym("2023-12"))

# Group the data by occurrence state and month, then sum deaths per month
Data_monthly <- Data_monthly %>%
  group_by(`Occurrence State`, year = year(`Month`), month = month(`Month`)) %>%
  summarise(Deaths = sum(Deaths))


# Merge the death data with population data by state and year
Data_monthly <- Data_monthly %>%
  left_join(population_data, by = c("Occurrence State" = "State", "year" = "year"))

# Calculate deaths per 100,000 inhabitants for each year
Data_monthly <- Data_monthly  %>%
  mutate(Deaths_per_100000 = (Deaths / population_count) * 100000)


# Create 'treatment' and 'post_policy' variables
Data_monthly <- Data_monthly %>%
  mutate(
    treatment = ifelse(`Occurrence State` == "Oregon", 1, 0),  # 1 for Oregon, 0 for California/Washington
    post_policy = ifelse(year >= 2021, 1, 0),  # 1 for years 2021 and later
    interaction = treatment * post_policy  # Interaction term for DiD
  )

# Create a new date column by combining year and month
Data_monthly <- Data_monthly %>%
  mutate(date = ym(paste(year, month, sep = "-")))  # Combine year and month into a date


# Difference-in-Differences (DiD) regression model with Deaths_per_100000

did_model <- lm(Deaths_per_100000 ~ treatment + post_policy + interaction, data = Data_monthly)
summary(did_model)

# Robust standard errors to handle heteroscedasticity
coeftest(did_model, vcov = vcovHC(did_model, type = "HC1"))

```

The **intercept** represents the baseline level of drug-related deaths per 100,000 in the control states (California and Washington) before the policy change, at 2.27 deaths per 100,000 inhabitants. The **treatment** coefficient of 0.24 indicates a slightly higher pre-policy death rate in Oregon compared to the control states, though this difference is not statistically significant (p = 0.1938). The **post-policy** coefficient of 1.73 indicates a significant overall increase in drug-related deaths across all states after 2021 (p < 2e-16). 

The **interaction term**, which captures the policy effect in Oregon relative to the control states, shows an additional increase of 0.55 deaths per 100,000 (p = 0.0379), suggesting that Oregon experienced a greater increase in deaths following the policy change compared to California and Washington. The model explains 55.31% of the variation in deaths (R-squared = 0.5531).


```{r Plot DiD}
# Plot DiD Results
# Plot the trends over time for each state
ggplot(Data_monthly, aes(x = date, y = Deaths_per_100000, color = `Occurrence State`)) +
  geom_line(linewidth = 1.2) +
  geom_vline(xintercept = as.Date("2021-02-01"), linetype = "dashed", color = "red") +  # Mark the policy change
  labs(title = "Drug-Related Deaths by State per 100000",
       subtitle = "Oregon policy change in February 2021",
       x = "Year", y = "Deaths_per_100000")


# Generate predicted values based on the model
Data_monthly$predicted <- predict(did_model, newdata = Data_monthly)

# Visualize the predicted trends
ggplot(Data_monthly, aes(x = date, y = predicted, color = `Occurrence State`)) +
  geom_line(linewidth = 1.2) +
  geom_vline(xintercept = as.Date("2021-02-01"), linetype = "dashed", color = "red") +  # Mark the policy change
  labs(title = "Predicted Drug-Related Deaths per 100,000 Over Time",
       subtitle = "Oregon vs Control States",
       x = "Date", y = "Predicted Deaths per 100,000 inhabitants")
```

### Robustness Check (Placebo Test)

To ensure the robustness of our findings,  Placebo tests will be applied by using the Difference-in-Differences (DiD) model to periods before the policy change (e.g., using a fictitious policy change date) to check if similar trends are observed. This helps confirm that the observed effects are not due to random fluctuations. If the placebo test shows no significant impact, it strengthens the validity of the actual policy analysis.

```{r Robustness Checks}
# Make a Difference-in-Differences model for the years 2018-2020 as a placebo test
Data_placebo <- Data_monthly %>%
  filter(date >= as.Date("2018-01-01") & date <= as.Date("2020-12-01"))

# Create 'treatment' and 'post_policy' variables for the placebo test
Data_placebo <- Data_placebo %>%
  mutate(
    treatment = ifelse(`Occurrence State` == "Oregon", 1, 0),  # 1 for Oregon, 0 for California/Washington
    post_policy = ifelse(year >= 2019, 1, 0),  # 1 for years 2019 and later
    interaction = treatment * post_policy  # Interaction term for DiD
  )

# Difference-in-Differences (DiD) model for the placebo test
did_model_placebo <- lm(Deaths_per_100000 ~ treatment + post_policy + interaction, data = Data_placebo)
summary(did_model_placebo)

# Robust standard errors for the placebo test
coeftest(did_model_placebo, vcov = vcovHC(did_model_placebo, type = "HC1"))
```

The results of the placebo test using a Difference-in-Differences (DiD) model show that the interaction term (policy effect) is not statistically significant (Estimate = 0.59, p = 0.92). This indicates that there is no meaningful effect of the "fictitious" policy change in the pre-treatment period (2018-2020).

The lack of a significant effect in this placebo test suggests that the actual policy change in 2021 is likely responsible for the observed increase in drug-related deaths, as there is no similar effect before the real policy was implemented. Additionally, the model shows that the treatment variable (Oregon) has a significant positive coefficient (Estimate = 20.62, p < 0.001), indicating that Oregon had higher baseline drug-related death rates compared to the control states (California and Washington) even before the policy change. However, the non-significant interaction term supports the conclusion that no random changes occurred in the placebo period.

This placebo test strengthens the validity of the original findings, suggesting that the observed policy effect is not due to random fluctuations but rather the actual decriminalization policy implemented in 2021.

### Regression Discontinuity Analysis

The Regression Discontinuity Analysis aims to further validate the Difference-in-Differences (DiD) results by examining the impact of the Oregon policy change in 2021 on drug-related deaths. By fitting a regression model to estimate the effect of the policy change, we can assess the significance of the increase in deaths following the policy implementation.

```{r Regression Discontinuity Analysis}
# Regression Discontinuity Analysis: To further validate the DiD results

# Filter the data for the entire period from 2018 to 2023
Data_RD <- Data_monthly %>%
  filter(date >= as.Date("2018-01-01") & date <= as.Date("2023-12-01") & `Occurrence State` == "Oregon")

# Create a binary variable for the policy change
Data_RD <- Data_RD %>%
  mutate(policy_change = ifelse(date >= as.Date("2021-02-01"), 1, 0))

# Fit a regression model to estimate the effect of the policy change
rd_model <- lm(Deaths_per_100000 ~ policy_change, data = Data_RD)
summary(rd_model)

# Robust standard errors to handle heteroscedasticity
coeftest(rd_model, vcov = vcovHC(rd_model, type = "HC1"))

# Plot the regression discontinuity analysis
ggplot(Data_RD, aes(x = date, y = Deaths_per_100000, color = as.factor(policy_change))) +
  geom_line(linewidth = 1.2) +
  geom_vline(xintercept = as.Date("2021-02-01"), linetype = "dashed", color = "red") +  # Mark the policy change
  # Legend
  scale_color_manual(values = c("0" = "blue", "1" = "red"), labels = c("Before Policy", "After Policy")) +
  labs(title = "Regression Discontinuity Analysis",
       subtitle = "Effect of Oregon Policy Change in 2021 (Oregon Only)",
       x = "Date", y = "Deaths per 100,000 inhabitants")

```

The regression discontinuity analysis indicates a significant increase in drug-related deaths following Oregon’s 2021 decriminalization policy. The updated model estimates an increase of approximately 2.25 deaths per 100,000 inhabitants after the policy change, with a highly significant p-value (p < 0.001), reinforcing the strong association between the policy and the rise in drug-related deaths. The model explains approximately 68% of the variance in deaths (R-squared = 0.6795). This suggests that the policy change accounts for a substantial portion of the observed increase in drug-related deaths. However, the remaining variance (about 32%) implies that other factors, such as external events or systemic issues, may still be influencing these trends. The relatively small residual standard error (0.7836) indicates that the model fits the data well, but further analysis is required to account for additional variables and potential long-term impacts of the policy change.

## Confounding Variables

### External Factors

When interpreting the results of our analysis, it is crucial to consider the potential impact of external factors that might confound the observed trends in drug-related deaths. Two significant external influences that could affect our results are the COVID-19 pandemic and various socioeconomic factors.

#### COVID-19 Pandemic

The COVID-19 pandemic, which began in early 2020, has had widespread and profound impacts on public health, economic stability, and social behaviors. The pandemic could have influenced drug-related deaths in several ways. The healthcare system strain during the pandemic potentially limited access to addiction treatment and other healthcare services. Increased stress, anxiety, and isolation during the pandemic may have led to higher substance use and overdose rates. Job losses and economic instability could have exacerbated substance abuse issues. Temporary changes in drug policy and law enforcement practices during the pandemic might have affected drug availability and usage patterns.

To account for the potential impact of COVID-19, we could include additional variables in our model, such as monthly COVID-19 case rates, unemployment rates, or other relevant indicators. This would help isolate the effect of the decriminalization policy from the broader impacts of the pandemic.

#### Socioeconomic Factors

Socioeconomic factors, such as income levels, employment rates, education, and housing stability, can significantly influence drug-related behaviors and health outcomes. Variations in these factors across states and over time could confound our analysis. Economic downturns or improvements can affect substance use patterns and access to treatment. Education levels might influence awareness and behaviors related to drug use and health. Homelessness or unstable housing situations can increase vulnerability to substance abuse and overdose.

Incorporating socioeconomic data into our analysis could provide a more nuanced understanding of the trends in drug-related deaths. We could use publicly available datasets to obtain state-level indicators of these factors and include them as covariates in our regression models.

## Time-series forecasting (ARIMA)

To predict future trends in drug-related deaths, we can use time-series forecasting models such as Autoregressive Integrated Moving Average (ARIMA). By fitting an ARIMA model to the historical data, we can generate forecasts for the upcoming years and assess the potential impact of the policy change on future death rates.

```{r Time-Series Forecasting ARIMA-2}
# Filter the data for Oregon and clean it
data_oregon <- Data %>%
  filter(`Occurrence State` == "Oregon") %>%
  filter(!Deaths == "Suppressed") %>%   # Handle suppressed values (remove them for now) 
  mutate(Deaths = as.numeric(Deaths),    # Convert Deaths to numeric
         date = as.Date(paste0(Month, "-01")))  # Create a proper date column

# Create a time series object for Oregon deaths
ts_oregon <- ts(data_oregon$Deaths, start = c(2018, 1), frequency = 12)

# Split the data for training (2018-2022) and validation (2023)
train_ts <- window(ts_oregon, end = c(2022, 12))
valid_ts <- window(ts_oregon, start = c(2023, 1), end = c(2023, 12))
full_train_ts <- window(ts_oregon, end = c(2023, 12))

# Fit an ARIMA model (or other model)
arima_model <- auto.arima(train_ts)
full_arima_model <- auto.arima(full_train_ts)

# Forecast for the validation period (2023-2024)
forecast_2023_2024 <- forecast(arima_model, h = 12)

# Plot the forecast against the actual validation data
plot(forecast_2023_2024)
lines(valid_ts, col = "red")  # Add the actual data for comparison
legend("topright", legend = c("Forecast", "Actual Data"), col = c("blue", "red"), lty = 1)

# compute the accuracy of the model
accuracy(forecast_2023_2024, valid_ts)

# After validating the model, forecast for 2025
forecast_2025 <- forecast(full_arima_model, h = 12)

# Plot the forecast for 2025
plot(forecast_2025, main = "Forecast for Drug-Related Deaths in Oregon (2025)",
     xlab = "Year", ylab = "Deaths per 100,000 inhabitants")

```	

The ARIMA model was trained on Oregon’s drug-related death data from 2018 to 2022 and validated using 2023 data. In the training set, the model exhibited a small bias, with a Mean Error (ME) of -0.11, indicating a slight underestimation of deaths. The Root Mean Squared Error (RMSE) of 5.32 and Mean Absolute Error (MAE) of 4.34 show moderate accuracy in predicting the actual values, though the model's tendency to under-predict is reflected in the Mean Percentage Error (MPE) of -31.75%. When validated on the 2023 test set, the model's performance slightly worsened, with an RMSE of 8.09 and MAPE of 22.89%, showing the forecasts deviated by an average of 22.89% from the actual data. Despite this, the model outperformed a naive forecast (Theil’s U = 0.85), suggesting that while it provides reasonable accuracy, further refinements are needed to improve predictions, particularly for future periods like 2025.

These results imply that drug-related deaths in Oregon post-2021 may be influenced by factors not fully captured by the model, such as behavioral, societal, or systemic changes induced by the policy. To improve the model's predictive accuracy, additional data, such as socioeconomic variables or more detailed health intervention metrics, and more advanced forecasting techniques, may be needed to capture the full scope of the policy's impact on drug-related deaths in the state.

## Panel Data Analysis 

```{r Panel Data Analysis}
# Panel Data Analysis
# Create a panel data set for the analysis
panel_data <- Data %>%
  select(`Occurrence State`, Month, Deaths) %>%
  mutate(State = factor(`Occurrence State`)) %>%
  select(-`Occurrence State`) %>%
  rename(Date = Month)

# Convert the Date column to a proper date format
panel_data$Date <- as.Date(paste0(panel_data$Date, "-01"))

# Aggregate the data to ensure unique state and date combinations
panel_data <- panel_data %>%
  group_by(State, Date) %>%
  summarise(Deaths = sum(Deaths, na.rm = TRUE)) %>%
  ungroup()

# Convert the data to a pdata.frame
pdata <- pdata.frame(panel_data, index = c("State", "Date"))

# Fit a panel data model to assess the impact of the policy change
panel_model <- plm(Deaths ~ lag(Deaths, 1), data = pdata, model = "within")

# Summarize the model
summary(panel_model)

# Robust standard errors for the panel data model
coeftest(panel_model, vcov = vcovHC(panel_model, type = "HC1"))

# Extract the index (State, Date) for the fitted model to align with fitted values
model_index <- index(panel_model)

# Create a dataframe with fitted values and corresponding index (State, Date)
fitted_data <- data.frame(State = model_index$State,
                          Date = model_index$Date,
                          Fitted = fitted(panel_model))

# Merge the fitted data with the original panel_data based on State and Date
panel_data_with_fitted <- merge(panel_data, fitted_data, by = c("State", "Date"))

# Plot the panel data model results using ggplot2
ggplot(panel_data_with_fitted, aes(x = Date, y = Deaths, color = State)) +
  geom_point() +
  geom_line(aes(y = Deaths), linetype = "solid") +  # Plot actual Deaths as solid line
  labs(title = "Panel Data Model Results",
       x = "Date",
       y = "Deaths",
       color = "State") +
  theme_minimal()

        ggplot(panel_data_with_fitted, aes(x = Date, y = Deaths, color = State)) +
      geom_point() +
      geom_line(aes(y = Deaths), linetype = "solid") +  # Plot actual Deaths as solid line
      geom_line(aes(y = Fitted), linetype = "dashed") +  # Plot fitted values as dashed line
      labs(title = "Panel Data Model Results",
           x = "Date",
           y = "Deaths",
           color = "State") +
      theme_minimal()
```