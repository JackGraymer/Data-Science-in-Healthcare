---
title: "DS Healthcare"
author: "Cervan, Del Conte, Kunz"
date: "2024-10-04"
output:
  pdf_document:
    toc: true
    toc_depth: 2
    number_sections: true
---

# Summary

This study aims to find out if the new "Ballot measure 110" regulation passed in the US state of Oregon in 2020 has had an impact on the number of drug-related deaths in the state. This measure decriminalized the possession of small amounts of drugs such as fentanyl and methamphetamine, among others. The data set used in this study  contains information on the number of drug-related deaths in Oregon and it´s neighbouring states, California and Washington from 2018 to 2024. The data set contains information on the month and year of the, the number, the state and the type of death.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Analysis

```{r libraries, include=FALSE}
library(readxl)
library(dplyr)
library(zoo)
library(lubridate)
library(ggplot2)
library(tidyr)
library(lmtest)
library(sandwich)

#setting directory
#setwd(dirname(rstudioapi::getSourceEditorContext()$path))
getwd()
```

## Data loading

```{r load main dataset}
# load the relevant part of the Data set, exclude notes starting from row 4374
Data <- read_excel("data/Drug_related_Deaths_2018-2024.xlsx", n_max = 4374)


# Overview for the Data
head(Data, 10)
str(Data)

```

```{r load populaiton Data, include=FALSE}
# Read population data from Excel file for each region

# Load the population data from the first range (D244:M244)
population_oregon_1 <- read_excel("data/Ca_Or_Wa Population 2010-23.xlsx", 
                                  sheet = "Oregon", 
                                  range = "D244:M244", 
                                  col_names = FALSE)  # Disable header reading

# Load the population data from the second range (Q244:T244)
population_oregon_2 <- read_excel("data/Ca_Or_Wa Population 2010-23.xlsx", 
                                  sheet = "Oregon", 
                                  range = "Q244:T244", 
                                  col_names = FALSE)  # Disable header reading

# Combine the two data frames (horizontally) into one row
population_oregon <- cbind(population_oregon_1, population_oregon_2)

# Manually set the column names (years 2010 to 2023)
colnames(population_oregon) <- 2010:2023



# Load the population data from the first range in California
population_california_1 <- read_excel("data/Ca_Or_Wa Population 2010-23.xlsx", 
                                  sheet = "California", 
                                  range = "D487:M487", 
                                  col_names = FALSE)  # Disable header reading

# Load the population data from the second range (Q487:T487)
population_california_2 <- read_excel("data/Ca_Or_Wa Population 2010-23.xlsx", 
                                  sheet = "California", 
                                  range = "Q487:T487", 
                                  col_names = FALSE)  # Disable header reading

# Combine the two data frames (horizontally) into one row
population_california <- cbind(population_california_1, population_california_2)

# Manually set the column names (years 2010 to 2023)
colnames(population_california) <- 2010:2023



# Load the population data from the first range in Washington
population_washington_1 <- read_excel("data/Ca_Or_Wa Population 2010-23.xlsx", 
                                  sheet = "Washington", 
                                  range = "D286:M286", 
                                  col_names = FALSE)  # Disable header reading

# Load the population data from the second range 
population_washington_2 <- read_excel("data/Ca_Or_Wa Population 2010-23.xlsx", 
                                  sheet = "Washington", 
                                  range = "Q286:T286", 
                                  col_names = FALSE)  # Disable header reading

# Combine the two data frames (horizontally) into one row
population_washington <- cbind(population_washington_1, population_washington_2)

# Manually set the column names (years 2010 to 2023)
colnames(population_washington) <- 2010:2023


# Combine population data into a single data frame with an added column for state
population_data <- bind_rows(
  population_oregon %>% mutate(State = "Oregon"),
  population_washington %>% mutate(State = "Washington"),
  population_california %>% mutate(State = "California")
)


# Remove the temporary variables from the environment
rm(population_oregon_1, population_oregon_2, population_washington_1, 
   population_washington_2, population_california_1, population_california_2,
   population_oregon, population_washington, population_california)

# Convert wide format to long format
population_data <- population_data %>%
  pivot_longer(cols = -State,    # All columns except 'State'
               names_to = "year",   # The new column for years
               values_to = "population_count")  # The new column for population counts

#Convert year collum to numeric
population_data$year <- as.numeric(population_data$year)  

```

## Data Exploration and Cleaning

```{r Data Explorations}

# look into Notes
unique(Data$Notes)

# only NA's so we delete this column
Data <- Data %>% select(-Notes)

# look into Dates
unique(Data$Month)

# Delete Row Sep., 2024 since the data is not complete
Data <- Data[Data$Month != "Sep., 2024 (provisional and partial)", ]

# Create column Provisional (TRUE/FALSE) based on the col Month '(provisional)'
Data$Provisional <- grepl("\\(provisional\\)", Data$Month)

# Delete " (provisional)" from the Date
####Data$Month <- gsub(" \\(provisional\\)", "", Data$Month)

# Convert into Date Variable
####Data$Month <- as.yearmon(Data$Month, format = "%b., %Y")
Data <- Data %>%
  #mutate(`Month` = as.yearmon(`Month Code`, format = "%Y/%m"))
    mutate(`Month` = ym(`Month Code`))


#### look into Deaths
#### Data$Deaths

# count of "Suppressed"
sum(Data$Deaths == "Suppressed")

# Some of the numbers are "Suppressed" this means that there are between 1 and 9 cases
# To use Deaths as a number we can leave them as NA's or substitute by a random number between 1 and 9

# Set seed for reproducibility if needed
set.seed(23)  

# Replace "Suppressed" in the Death column with a random number between 1 and 9
Data$Deaths <- ifelse(Data$Deaths == "Suppressed", sample(1:9, sum(Data$Deaths == "Suppressed"), replace = TRUE), Data$Deaths)
Data$Deaths <- as.numeric(Data$Deaths)

summary(Data)
sum(Data$Deaths == "Suppressed")
# Delete all columns that end on Code, they are duplicates of the other columns
Data <- Data[, !grepl("Code$", names(Data))]

glimpse(Data)
```

## Baseline and Trend Analysis
We will calculate the drug-related death rates for Oregon, California, and Washington for all complete years in our dataset. We then focus on the years 2018-2023y prior to the law’s enactment, to establish any pre-existing trends. 
Although the dataset does not include details on socioeconomic factors or the effects of COVID-19, we will acknowledge these as potential confounding variables and incorporate them into the discussion when interpreting the results. This analysis will help isolate changes attributable to the law rather than external factors.


```{r Baseline and Trend Analysis}

# Filter the data for each complete years 2018 to 2023 
Data_18_23 <- Data %>%
  filter(`Month` >= ym("2018-01") & `Month` <= ym("2023-12"))

# Group the data by occurrence state and year, then sum deaths per year
Data_18_23 <- Data_18_23 %>%
  group_by(`Occurrence State`, year = year(`Month`)) %>%
  summarise(Deaths = sum(Deaths))

# Merge the death data with population data by state and year
Data_with_populatio <- Data_18_23 %>%
  left_join(population_data, by = c("Occurrence State" = "State", "year" = "year"))

# Calculate deaths per 100,000 inhabitants for each year
Data_with_population <- Data_with_population %>%
  mutate(Deaths_per_100000 = (Deaths / population_count) * 100000)

# View the result
print(Data_with_population)

# Plot the number of deaths per 10,000 inhabitants for each year and state
ggplot(Data_with_population, aes(x = factor(year), y = Deaths_per_100000, fill = `Occurrence State`)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Drug-Related Deaths per 100'000 Inhabitants (2018-2023)",
       x = "Year",
       y = "Deaths per 100'000 Inhabitants") +
  theme_minimal()


# Plot the trends over time for each state per year
ggplot(Data_with_population, aes(x = year, y = Deaths_per_100000, color = `Occurrence State`)) +
  geom_line(linewidth = 1.2) +
  geom_vline(xintercept = 2021, linetype = "dashed", color = "red") +  # Mark the policy change
  labs(title = "Drug-Related Deaths per 100,000 Inhabitants by State",
       subtitle = "Oregon policy change in 2021",
       x = "Year", y = "Deaths per 100,000 inhabitants") +
  theme_minimal()



```
# For this Analyis we wanted to look at the monthly numbers

```{r Diference In  Analysis}

# Filter the data for each complete month in 2018 to 2023 
Data_monthly <- Data %>%
  filter(`Month` >= ym("2018-01") & `Month` <= ym("2023-12"))

# Group the data by occurrence state and month, then sum deaths per month
Data_monthly <- Data_monthly %>%
  group_by(`Occurrence State`, year = year(`Month`), month = month(`Month`)) %>%
  summarise(Deaths = sum(Deaths))


# Merge the death data with population data by state and year
Data_monthly <- Data_monthly %>%
  left_join(population_data, by = c("Occurrence State" = "State", "year" = "year"))

# Calculate deaths per 100,000 inhabitants for each year
Data_monthly <- Data_monthly  %>%
  mutate(Deaths_per_100000 = (Deaths / population_count) * 100000)


# Create 'treatment' and 'post_policy' variables
Data_monthly <- Data_monthly %>%
  mutate(
    treatment = ifelse(`Occurrence State` == "Oregon", 1, 0),  # 1 for Oregon, 0 for California/Washington
    post_policy = ifelse(year >= 2021, 1, 0),  # 1 for years 2021 and later
    interaction = treatment * post_policy  # Interaction term for DiD
  )

# Create a new date column by combining year and month
Data_monthly <- Data_monthly %>%
  mutate(date = ym(paste(year, month, sep = "-")))  # Combine year and month into a date


# Difference-in-Differences (DiD) regression model with Deaths_per_100000

did_model <- lm(Deaths_per_100000 ~ treatment + post_policy + interaction, data = Data_monthly)

# Get the summary of the model to evaluate the effect
summary(did_model)

# Use robust standard errors to handle heteroscedasticity
coeftest(did_model, vcov = vcovHC(did_model, type = "HC1"))


# Plot the trends over time for each state
ggplot(Data_monthly, aes(x = date, y = Deaths_per_100000, color = `Occurrence State`)) +
  geom_line(linewidth = 1.2) +
  geom_vline(xintercept = as.Date("2021-02-01"), linetype = "dashed", color = "red") +  # Mark the policy change
  labs(title = "Drug-Related Deaths by State per 100000",
       subtitle = "Oregon policy change in February 2021",
       x = "Year", y = "Deaths_per_100000") +
  theme_minimal()



```